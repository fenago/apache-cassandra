**

![](data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4NCjwhLS0gR2VuZXJhdG9yOiBBZG9iZSBJbGx1c3RyYXRvciAxOS4yLjAsIFNWRyBFeHBvcnQgUGx1Zy1JbiAuIFNWRyBWZXJzaW9uOiA2LjAwIEJ1aWxkIDApICAtLT4NCjxzdmcgdmVyc2lvbj0iMS4xIiBpZD0iTGF5ZXJfMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgeD0iMHB4IiB5PSIwcHgiDQoJIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCAxMDAgMTAwOyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+DQo8c3R5bGUgdHlwZT0idGV4dC9jc3MiPg0KCS5zdDB7ZmlsbDojRDBEMkQzO30NCgkuc3Qxe2ZpbGw6I0E2QThBQjt9DQoJLnN0MntmaWxsOiMwODdBOTY7fQ0KCS5zdDN7ZmlsbDojMjMxRjIwO30NCjwvc3R5bGU+DQo8Zz4NCgk8Zz4NCgkJPGc+DQoJCQkNCgkJCQk8ZWxsaXBzZSB0cmFuc2Zvcm09Im1hdHJpeCgwLjk5OTcgLTIuNDIxNTMzZS0wMDIgMi40MjE1MzNlLTAwMiAwLjk5OTcgLTEuOTQ5NyAxLjk3MzQpIiBjbGFzcz0ic3QwIiBjeD0iODAuNSIgY3k9IjgxLjUiIHJ4PSI2IiByeT0iNiIvPg0KCQk8L2c+DQoJCTxnPg0KCQkJPHBhdGggY2xhc3M9InN0MSIgZD0iTTYxLjMsOTBjMCwxLjksMS43LDMuNSwzLjYsMy40YzIsMCwzLjUtMS43LDMuNC0zLjZjMC0xLjktMS43LTMuNS0zLjYtMy40QzYyLjgsODYuNSw2MS4zLDg4LjEsNjEuMyw5MHoiLz4NCgkJPC9nPg0KCQk8Zz4NCgkJCTxwYXRoIGNsYXNzPSJzdDAiIGQ9Ik04LjMsMjMuNGMwLjEsMi4xLDEuOCwzLjgsNCwzLjhjMi4xLTAuMSwzLjgtMS44LDMuOC00Yy0wLjEtMi4xLTEuOC0zLjgtNC0zLjhDMTAsMTkuNSw4LjMsMjEuMyw4LjMsMjMuNHoiDQoJCQkJLz4NCgkJPC9nPg0KCQk8Zz4NCgkJCTxwYXRoIGNsYXNzPSJzdDEiIGQ9Ik03LjksMzguN2MwLDEuNywxLjQsMywzLjEsM2MxLjcsMCwzLTEuNCwzLTMuMWMwLTEuNy0xLjQtMy0zLjEtM0M5LjEsMzUuNyw3LjgsMzcsNy45LDM4Ljd6Ii8+DQoJCTwvZz4NCgk8L2c+DQo8L2c+DQo8Zz4NCgk8Zz4NCgkJPGc+DQoJCQk8Zz4NCgkJCQkNCgkJCQkJPGVsbGlwc2UgdHJhbnNmb3JtPSJtYXRyaXgoMC45OTk3IC0yLjQyODI3MWUtMDAyIDIuNDI4MjcxZS0wMDIgMC45OTk3IC0xLjQyNjEgMi4wNDI3KSIgY2xhc3M9InN0MiIgY3g9IjgzLjQiIGN5PSI1OS43IiByeD0iOC40IiByeT0iOC40Ii8+DQoJCQk8L2c+DQoJCQk8Zz4NCgkJCQk8cGF0aCBjbGFzcz0ic3QyIiBkPSJNNDAuNCwxOS40YzAuMSw0LjcsNCw4LjQsOC42LDguMmM0LjctMC4xLDguNC00LDguMi04LjdjLTAuMS00LjctNC04LjMtOC43LTguMg0KCQkJCQlDNDQsMTAuOCw0MC4zLDE0LjcsNDAuNCwxOS40eiIvPg0KCQkJPC9nPg0KCQkJPGc+DQoJCQkJDQoJCQkJCTxlbGxpcHNlIHRyYW5zZm9ybT0ibWF0cml4KDAuOTk5NyAtMi40MzI1NjJlLTAwMiAyLjQzMjU2MmUtMDAyIDAuOTk5NyAtMC4zMTM5IDAuNjQ5NikiIGNsYXNzPSJzdDIiIGN4PSIyNi41IiBjeT0iMTMuMiIgcng9IjYuNSIgcnk9IjYuNSIvPg0KCQkJPC9nPg0KCQkJPGc+DQoJCQkJDQoJCQkJCTxlbGxpcHNlIHRyYW5zZm9ybT0ibWF0cml4KDAuOTk5NyAtMi40MjE1MzNlLTAwMiAyLjQyMTUzM2UtMDAyIDAuOTk5NyAtMS45NDU0IDEuOTgwNikiIGNsYXNzPSJzdDIiIGN4PSI4MC44IiBjeT0iODEuMyIgcng9IjYiIHJ5PSI2Ii8+DQoJCQk8L2c+DQoJCQk8Zz4NCgkJCQk8cGF0aCBjbGFzcz0ic3QyIiBkPSJNNjEuNiw4OS45YzAsMS45LDEuNywzLjUsMy42LDMuNGMyLDAsMy41LTEuNywzLjQtMy42YzAtMS45LTEuNy0zLjUtMy42LTMuNA0KCQkJCQlDNjMuMSw4Ni4zLDYxLjYsODcuOSw2MS42LDg5Ljl6Ii8+DQoJCQk8L2c+DQoJCQk8Zz4NCgkJCQk8cGF0aCBjbGFzcz0ic3QyIiBkPSJNOC42LDIzLjJjMC4xLDIuMSwxLjgsMy44LDQsMy44YzIuMS0wLjEsMy44LTEuOCwzLjgtNGMtMC4xLTIuMS0xLjgtMy44LTQtMy44DQoJCQkJCUMxMC4zLDE5LjMsOC42LDIxLjEsOC42LDIzLjJ6Ii8+DQoJCQk8L2c+DQoJCQk8Zz4NCgkJCQk8cGF0aCBjbGFzcz0ic3QyIiBkPSJNOC4yLDM4LjVjMCwxLjcsMS40LDMsMy4xLDNjMS43LDAsMy0xLjQsMy0zLjFjMC0xLjctMS40LTMtMy4xLTNDOS40LDM1LjUsOC4xLDM2LjksOC4yLDM4LjV6Ii8+DQoJCQk8L2c+DQoJCQk8Zz4NCgkJCQk8cGF0aCBjbGFzcz0ic3QyIiBkPSJNNTkuNSwzNi44YzAuMSw1LjgsNSwxMC40LDEwLjgsMTAuM2M1LjgtMC4xLDEwLjQtNSwxMC4zLTEwLjhjLTAuMS01LjgtNS0xMC40LTEwLjgtMTAuMw0KCQkJCQlDNjQsMjYuMSw1OS40LDMxLDU5LjUsMzYuOHoiLz4NCgkJCTwvZz4NCgkJPC9nPg0KCTwvZz4NCgk8Zz4NCgkJPGc+DQoJCQk8cGF0aCBjbGFzcz0ic3QzIiBkPSJNMzguNyw2OC43bDEzLTEzLjFjMC42LTAuNiwwLjctMS42LDAuNC0yLjRjLTAuNC0wLjgtMS4xLTEuMy0yLTEuM2MtMC42LDAtMS4xLDAuMi0xLjUsMC42bC0xMi45LDEzDQoJCQkJTDIyLjYsNTIuNGMtMC40LTAuNC0xLTAuNi0xLjUtMC42Yy0wLjksMC0xLjcsMC41LTIsMS40Yy0wLjMsMC44LTAuMSwxLjcsMC41LDIuNGwxMy4xLDEzLjJsLTEyLjksMTNjLTAuNiwwLjYtMC44LDEuNS0wLjUsMi40DQoJCQkJYzAuMywwLjgsMS4xLDEuMywyLDEuM2MwLjYsMCwxLjEtMC4yLDEuNS0wLjZsMTIuOS0xM2wxMy4xLDEyLjFjMC40LDAuNCwxLDAuNiwxLjUsMC42YzAuOSwwLDEuNi0wLjUsMi0xLjMNCgkJCQljMC4zLTAuOCwwLjItMS43LTAuNC0yLjRMMzguNyw2OC43eiIvPg0KCQkJPHBhdGggY2xhc3M9InN0MyIgZD0iTTIxLjMsODYuNGMtMS4zLDAtMi40LTAuOC0yLjktMmMtMC41LTEuMi0wLjItMi41LDAuNy0zLjVsMTIuMi0xMi4zTDE4LjgsNTYuMmMtMC45LTAuOS0xLjItMi4yLTAuNy0zLjQNCgkJCQljMC41LTEuMiwxLjctMiwyLjktMmMwLjgsMCwxLjYsMC4zLDIuMiwwLjlsMTIuNCwxMi41bDEyLjItMTIuM2MwLjYtMC42LDEuNC0wLjksMi4yLTAuOWMxLjMsMCwyLjQsMC44LDIuOSwxLjkNCgkJCQljMC41LDEuMiwwLjMsMi41LTAuNiwzLjRMNDAuMiw2OC42TDUyLjUsODBjMSwxLDEuMiwyLjQsMC43LDMuNWMtMC41LDEuMi0xLjcsMS45LTIuOSwxLjljLTAuOCwwLTEuNi0wLjMtMi4yLTAuOUwzNS43LDczLjENCgkJCQlMMjMuNSw4NS40QzIyLjksODYsMjIuMSw4Ni40LDIxLjMsODYuNHogTTIxLjEsNTIuOGMtMC41LDAtMC45LDAuMy0xLjEsMC43Yy0wLjIsMC40LTAuMSwwLjksMC4zLDEuM0wzNCw2OC43TDIwLjUsODIuMw0KCQkJCWMtMC40LDAuNC0wLjUsMC44LTAuMywxLjNjMC4zLDAuNywxLjMsMC45LDEuOSwwLjRsMTMuNi0xMy43bDEzLjgsMTIuN2MwLjcsMC43LDEuNiwwLjQsMS45LTAuM2MwLjItMC40LDAuMS0wLjktMC4zLTEuMw0KCQkJCUwzNy4zLDY4LjdMNTEsNTQuOWMwLjMtMC4zLDAuNC0wLjgsMC4yLTEuM2MtMC4zLTAuNy0xLjMtMC45LTEuOS0wLjRMMzUuNyw2N0wyMS45LDUzLjFDMjEuNyw1Mi45LDIxLjQsNTIuOCwyMS4xLDUyLjh6Ii8+DQoJCTwvZz4NCgk8L2c+DQo8L2c+DQo8L3N2Zz4NCg==)fenago
Studio

**

socrates73@gmail.com

▾

Connection: socrates73@gmail.com Host/IP:

**SchemaView Schema

**View Notebook History

Studio Help

 







![line](https://raw.githubusercontent.com/fenago/apache-cassandra/master/datadrax_images/line.png "line")

Set Up the Notebook

### In this section, you will do the following things:

- Execute a CQL script to initialize the KillrVideo database for this notebook

**Step 1:** Execute the following cell to initialize this notebook. Hover over the right-hand corner of that cell and click the *Run* button.

![line](https://raw.githubusercontent.com/fenago/apache-cassandra/master/datadrax_images/ExecuteCell.png "line")

**Note:** You don't see the CQL script because the code editor is hidden, but you can still run the cell.






Add a Cell

 








![line](https://raw.githubusercontent.com/fenago/apache-cassandra/master/datadrax_images/line.png "line")

`INSERT` with Lightweight Transactions (LWTs)

### In this section, you will do the following things:

- Insert a new row using an LWT

- Insert an existing row using an LWT

- Observe the two behaviors (and compare them to an upsert)

**Here's the story:**

#### Imagine we want to create a new KillrVideo user. To do so, we need to create an entry in the `user_credentials` table with a specified email address. But we don’t want to create a new user if there is a user already with that email address.

#### We could read the database to determine if the user exists already, but what if, between reading and creating the user, somebody else creates the same user. That would cause an upsert that we want to avoid.

#### Instead, we’ll create the user with a lightweight transaction (LWT). This will make sure that Cassandra does a read-before-write as an atomic operation.



**Step 1:** In the following cell, Write an `INSERT` command, with an LWT, to create a user in the `user_credentials` table. Use the following table to inform your values.

Column Name

Value

email

'cv@fenago.com`

password

'3@$tC0@$tC@ss@ndr@'

userid




 


*Need a hint? Click here.*

#### As mentioned, create an `INSERT` command for the `killrvideo.user_credentials` table. Use the column names and values from the table above. Tack on the `IF NOT EXISTS` clause (this is the LWT) to the end of the statement.


*Just want the command? Click here.*

    INSERT INTO killrvideo.user_credentials (email, password, userid)
    VALUES('cv@fenago.com', '3@$tC0@$tC@ss@ndr@', 55555555-5555-5555-5555-555555555555)
    IF NOT EXISTS;




// Enter and execute the insert command in this cell

// Remember, click in the cell and press SHIFT+ENTER or click the Run
button in the top-right corner






The `INSERT` returns a table with a single column named `[applied]`
(with the square brackets in the name of the column).

![UCLWTSuccess](https://raw.githubusercontent.com/fenago/apache-cassandra/master/datadrax_images/UCLWTSuccess.png)

When the `[applied]` column has a Boolean value of `true`, it means the
`INSERT` succeeded. 


**Step 2:** In the next cell, run the exact same `INSERT` command you ran in Step 1.


 


*Need a hint? Click here.*

#### We're all out of hints! Just copy the command you used in the previous step.


*Just want the command? Click here.*

    INSERT INTO killrvideo.user_credentials (email, password, userid)
    VALUES('cv@fenago.com', '3@$tC0@$tC@ss@ndr@', 55555555-5555-5555-5555-555555555555)
    IF NOT EXISTS;




// Enter and execute the same command in this cell as you did in the
previous step

// Remember, click in the cell and press SHIFT+ENTER or click the Run
button in the top-right corner






#### Notice that this time the `INSERT` returns a row that includes the `[applied]` column along with the other columns from the table. Also note that the value of the `[applied]` column is a Boolean `false`.

#### This means that the LWT found a record violating the condition. In this case, it's the row we previously inserted. Rather than upserting the row, the LWT returned the row it read, and noted that the write failed (in the `[applied]` column):

![UCLWTFail](https://raw.githubusercontent.com/fenago/apache-cassandra/master/datadrax_images/UCLWTFail.png)








![line](https://raw.githubusercontent.com/fenago/apache-cassandra/master/datadrax_images/line.png "line")

`UPDATE` with Lightweight Transactions (LWTs)

### In this section, you will do the following things:

- We'll use an `UPDATE` with an LWT that succeeds

- We'll use an `UPDATE` with an LWT that fails

- We'll explain why you care about updates and LWTs

    

**Here's the story:**

#### Sometimes, when you want to update a record, you may run into a similar situation as you did with the insert. For example, let’s say we want to update the password column, but only if the column value has not already been updated. We can use an LWT for this too.

#### First, let’s simulate getting the current password - since that is what your code would have to do.



**Step 1:** In the cell that follows, write CQL to query for the user you just created


 


*Need a hint? Click here.*

#### You are writing a `SELECT` statement to query the `killrvideo.user_credentials` table. Since the primary key is the `email`, you want to search for the email value of `'cv@fenago.com'`.


*Just want the command? Click here.*

    SELECT * FROM killrvideo.user_credentials WHERE email = 'cv@fenago.com';




// Enter and execute the query to retrieve the user you created in the
previous section

// Remember, click in the cell and press SHIFT+ENTER or click the Run
button in the top-right corner






#### Let’s imagine we want to change the password value from `3@$tC0@$tC@ss@ndr@` to `password_A`, but only if nobody has changed the password yet (we realize the security gods would hate you for using this simple password, but let's ignore them for now). We can do that with LWT.



**Step 2:** In the cell that follows, write an `UPDATE` command to change the user's password from `'3@$tC0@$tC@ss@ndr@'` to `'Password_A'`. Use an LWT to make sure the password wasn't already changed.


 


*Need a hint? Click here.*

#### You are writing an `UPDATE` statement for the `killrvideo.user_credentials` table. Since the primary key is the `email`, you want to update the row with the `email` value of `'cv@fenago.com'`. You will use the LWT with the form `IF password = '3@$tC0@$tC@ss@ndr@'`.


*Just want the command? Click here.*

    UPDATE killrvideo.user_credentials
    SET password = 'password_A'
    WHERE email = 'cv@fenago.com'
    IF password = '3@$tC0@$tC@ss@ndr@';




// Enter and execute the update with LWT here

// Remember, click in the cell and press SHIFT+ENTER or click the Run
button in the top-right corner






#### The LWT checks that the `password` is what we expect. Notice the resulting value in the `[applied]` column is `true`.

#### What does this mean?


*If you're not sure, click here.* 

#### When an LWT executes and the resulting `[applied]` column is `true`, the LWT succeeded.

#### When the `[applied]` column contains a `false` value, the LWT failed to do the `UPDATE`.



#### Now, let’s simulate updating the password when it is NOT what we think it is.



#### For example, after we read the record to prepare for the `UPDATE`, imagine somebody else changes the password before we can. If we blindly apply our change, we may overwrite the change they applied.

**Step 3:** Execute an `UPDATE` in the following cell to simulate this situation (noticing that the record currently contains the password `password_A`). Set the `password` to `'password_B'` if the current password is `'3@$tC0@$tC@ss@ndr@'`.


 


*Need a hint? Click here.*

#### Copy the `UPDATE` from the previous step. Then modify the `SET` clause to set the `password` to `password_B`.


*Just want the command? Click here.*

    UPDATE killrvideo.user_credentials
    SET password = 'password_B'
    WHERE email = 'cv@fenago.com'
    IF password = '3@$tC0@$tC@ss@ndr@';




// Enter and execute the update with LWT here

// Remember, click in the cell and press SHIFT+ENTER or click the Run
button in the top-right corner






#### Of course, the LWT failed (as indicated by the `false` value in the `[applied]` column). Do you understand why?


*If you're not sure, click here.* 

The LWT attempts to `UPDATE` the row if and only if the current
`password` value is `3@$tC0@$tC@ss@ndr@`. 
The row's `password` value is `password_A`. 
So, when the LWT reads the record and sees that the `password` value
is not the specified value (i.e. `3@$tC0@$tC@ss@ndr@`), the LWT fails
the `UPDATE`. 



#### Just to make sure we understand, let's select the row and verify the values of its columns.



**Step 4:** Write a `SELECT` statement to retrieve the updated row and execute it in the following CQL cell:


 


*Need a hint? Click here.*

#### Retrieve the row from `killrvideo.user_credentails` where the `email` is `cv@fenago.com`.


*Just want the command? Click here.*

    SELECT * FROM killrvideo.user_credentials WHERE email = 'cv@fenago.com';




// Enter and execute the select statement here

// Remember, click in the cell and press SHIFT+ENTER or click the Run
button in the top-right corner






![line](https://raw.githubusercontent.com/fenago/apache-cassandra/master/datadrax_images/line.png "line")

Batches

### In this section, you will do the following things:

- We'll explore the batch concept and understand when to use it

- We'll use a `BATCH` command to insert rows in each of two denormalized tables

**Note:** The keyword `BATCH` has a completely different meaning in CQL than SQL. Please be careful not to confuse the two.



**Here's the story:**

#### As we have seen in Cassandra, we denormalize data so that we can build tables for fast, scalable access. By definition, denormalization requires that we insert redundant data into two or more tables. This can cause problems. Imagine two writes to two denormalized tables. If one write succeeds and the other, for reasons unknown, fails, the tables are permanently inconsistent. Batches help us solve this problem by making sure that the data gets written to both tables.

#### Batches sound a little like traditional transactions, and in some ways, they are. Traditional transactions will commit to both writes or, if one write fails, it rolls back the successful write. Alternatively, batches just keep trying until both writes succeed.



#### Two KillrVideo tables that contain denormalized data are the `users` table and the `users_credentials table`. In the previous section, we only wrote to the `user_credentials` table, so our tables are now out of sync. Let's fix that! We'll start by deleting the row we inserted in the previous sections, and then we'll add it back in to both tables using batches.



**Step 1:** In the following cell, delete the row with the `email` of `cv@fenago.com` from the `user_credentials` table.


 


*Need a hint? Click here.*

#### You will use the `DELETE` command on the `killrvideo.user_credentials` table. Since we want to delete all columns in the row, leave the column specification clause empty. In the `WHERE` clause, be sure to specify the `email` as `cv@fenago.com`


*Just want the command? Click here.*

    DELETE FROM killrvideo.user_credentials WHERE email = 'cv@fenago.com';




// Enter and execute the delete command here

// Remember, click in the cell and press SHIFT+ENTER or click the Run
button in the top-right corner






#### Let's review the contents of both the `users` table and the `user_credentials` table.



**Step 2:** Execute the next two cells to view the contents of both tables.




// This command will let you review the contents of the
user_credentials table.

// This command requires a full table scan, which means it's fine on
small tables like this on, but will not be performant for large
production tables.

// Remember, click in the cell and press SHIFT+ENTER or click the Run
button in the top-right corner

SELECT * FROM killrvideo.user_credentials;






// This command will let you review the contents of the users table.

// This command requires a full table scan, which means it's fine on
small tables like this on, but will not be performant for large
production tables.

// Remember, click in the cell and press SHIFT+ENTER or click the Run
button in the top-right corner

SELECT * FROM killrvideo.users;






#### Note two points about these tables:

- The contents of the tables are consistent - the redundant data is identical in both tables

- Cristina's data does not show up in either table



#### Let's add a row to each table for Cristina. The following table gives you her data:

Column Name

Value

firstname

'Cristina'

lastname

'Veale'

email

'cv@fenago.com`

password

'3@$tC0@$tC@ss@ndr@'

userid





**Step 3:** In the following cell, write and execute the CQL to insert a row into each table. Use a batch to make sure the code updates both tables.


 


*Need a hint? Click here.*

#### You will write two `INSERT` statements and surround them with `BEGIN BATCH`/`APPLY BATCH`. One of the `INSERT` statements should create a row in the `users` table and the other `INSERT` statement should create a row in the `user_credentials` table. Use the table above for the values of each insert. Also, don't forget to use `toTimestamp(now())` as the value for the `created_date` column.


*Just want the CQL? Click here.*

    BEGIN BATCH
    INSERT INTO killrvideo.user_credentials (email, password, userid)
      VALUES('cv@fenago.com', '3@$tC0@$tC@ss@ndr@', 55555555-5555-5555-5555-555555555555);
    INSERT INTO killrvideo.users (userid, created_date, firstname, lastname, email)
      VALUES(55555555-5555-5555-5555-555555555555, toTimestamp(now()), 'Cristina', 'Veale', 'cv@fenago.com');
    APPLY BATCH




// Write and execute the batch with the two inserts here

// Remember, click in the cell and press SHIFT+ENTER or click the Run
button in the top-right corner






#### Finally, let's review the contents of both the `users` table and the `user_credentials` table and verify the changes

**Step 4:** Execute the next two cells to view the contents of both tables.




// This command will let you review the contents of the users table.

// This command requires a full table scan, which means it's fine on
small tables like this on, but will not be performant for large
production tables.

// Remember, click in the cell and press SHIFT+ENTER or click the Run
button in the top-right corner

SELECT * FROM killrvideo.users;






// This command will let you review the contents of the
user_credentials table.

// This command requires a full table scan, which means it's fine on
small tables like this on, but will not be performant for large
production tables.

// Remember, click in the cell and press SHIFT+ENTER or click the Run
button in the top-right corner

SELECT * FROM killrvideo.user_credentials;






#### Review the results in the previous two cells. If you carefully compare them with results from Step 2, you should find the row in each table containing Cristina's data.








![line](https://raw.githubusercontent.com/fenago/apache-cassandra/master/datadrax_images/line.png "line")

Congratulations!!!!




![line](https://raw.githubusercontent.com/fenago/apache-cassandra/master/datadrax_images/line.png "line")

Bonus Challenge: Using TTL

If you got done early and want something to do while you wait for
others, here's a bonus challenge

### In this section, you will do the following things:

- Create a table to keep track of video positions for each user

- We will cause entries in the new table to expire after a period of time using TTL

**Here's the pitch:**

#### Imagine while a user is playing a video, they decide to pause it. Further, we want to keep track of where they paused so we can restart the video at that point. However, we don't want to keep track of every time every user pauses a video forever. This information is probably only useful for a limited period of time, so after that period we would like the data to just go away.

#### This is where Time To Live (TTL) comes in. We can set a value (in seconds) for how long a column value should exist. After that amount of time passes, Cassandra automatically removed the value from that column. Let's see how it works…



**Step 1:** In the next cell, write and execute the CQL to create a table named `video_positions_by_user`.

- Make the `userid` the primary key

- Include the following columns in the table

Column Name

Data Type

userid

UUID

videoid

UUID

video_position

INT


*Want the solution? Click here.*

    CREATE TABLE killrvideo.video_positions_by_user (
        userid          UUID,
        videoid         UUID,
        video_position  INT,
        PRIMARY KEY (userid)
    );




// Write and execute the CQL to create the video_positions_by_user
table

// Remember, click in the cell and press SHIFT+ENTER or click the Run
button in the top-right corner






**Step 2:** In the following cell, insert a row into the `video_positions_by_user` table using TTL.

- Set the TTL on the `videoid` and `video_position` values to five minutes (300 seconds) with the clause `USING TTL 300` at the end of the statement

- Use the values in the following table

Column Name

Column Value

userid



videoid

aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa

video_position



* * * * *

**Note:** Once you execute the `INSERT` command, proceed directly to the next step. You will want to execute the next step within the TTL window. Time is ticking…

* * * * *


*Want the solution? Click here.*

    INSERT INTO killrvideo.video_positions_by_user
        (userid, videoid, video_position)
        VALUES(11111111-1111-1111-1111-111111111111, aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa, 42)
        USING TTL 300;




// Write and execute the CQL to insert the row into
video_positions_by_user table with the TTL of 180

// Remember, click in the cell and press SHIFT+ENTER or click the Run
button in the top-right corner






**Step 3:** Inspect how much time is left for the row's values.

- Execute the following cell to see how much time is left on the TTL for the `videoid` value

- You may want to execute the next cell several times and watch the TTL value count down

- In fact, continue to execute this query every few seconds until the TTL expires (just to see what happens)

- Notice that Cassandra associates TTL values with column values (not the row), so the query selects the TTL for a specific column




// Execute this cell to see how much time is left on the TTL for the
videoid value

// Remember, click in the cell and press SHIFT+ENTER or click the Run
button in the top-right corner

SELECT videoid, TTL(videoid) FROM killrvideo.video_positions_by_user
WHERE userid = 11111111-1111-1111-1111-111111111111;






#### As we mentioned, Cassandra associates the TTL with a value in the row. This implies we could set different TTLs for different columns. How might we do that? Glad you asked…

**Step 4:** In the following cell, insert the same row again into the `video_positions_by_user` table using TTL.

- Again, set the TTL for to 300 seconds with the clause `USING TTL 300` at the end of the statement

- Here is the table again for your reference

Column Name

Column Value

userid



videoid

aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa

video_position




*Want the solution? Click here.*

    INSERT INTO killrvideo.video_positions_by_user
        (userid, videoid, video_position)
        VALUES(11111111-1111-1111-1111-111111111111, aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa, 42)
        USING TTL 300;




// Write and execute the CQL to insert the row into
video_positions_by_user table with the TTL of 180

// Remember, click in the cell and press SHIFT+ENTER or click the Run
button in the top-right corner






**Step 5:** Execute the following cell to reset the value of the TTL for *only* the videoid value.

* * * * *

**Note:** You may only set TTLs for values of non-primary key columns.

* * * * *




// Execute this cell to see how much time is left on the TTL for the
videoid value

// Remember, click in the cell and press SHIFT+ENTER or click the Run
button in the top-right corner

UPDATE killrvideo.video_positions_by_user

USING TTL 300

SET videoid = aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa

WHERE userid = 11111111-1111-1111-1111-111111111111;






**Step 6:** Execute the following cell repeatedly to watch the TTLs count down.

- Continue to execute the next cell until both TTLs expire

- We know, the suspense is killing you…




// Execute this cell to see how much time is left on the TTL for both of
the row's values

// Remember, click in the cell and press SHIFT+ENTER or click the Run
button in the top-right corner

SELECT videoid, TTL(videoid), video_position, TTL(video_position) FROM
killrvideo.video_positions_by_user WHERE userid =








